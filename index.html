<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>g1 Brookasil | Onde a notícia acontece</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Cores G1 e Twitter */
            --primary: #c4170c; /* G1 Red */
            --secondary: #1d9bf0; /* Twitter Blue */
            --dark: #121212;
            --light: #ffffff;
            --gray: #eff3f4;
            --text-main: #0f1419;
            --text-sec: #536471;
            --border: #eff3f4;
            --shadow: rgba(0, 0, 0, 0.05);
            --success: #00ba7c;
            --danger: #f4212e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: #fff; color: var(--text-main); overflow-x: hidden; }
        a { text-decoration: none; color: inherit; cursor: pointer; }
        ul { list-style: none; }
        button { cursor: pointer; border: none; background: none; transition: 0.2s; }
        input, textarea, select { outline: none; border: 1px solid #ccc; border-radius: 4px; padding: 10px; width: 100%; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--secondary); }

        /* Layout Grid */
        .app-container {
            display: grid;
            grid-template-columns: 275px 1fr 350px;
            max-width: 1300px;
            margin: 0 auto;
            min-height: 100vh;
        }

        /* Sidebar Esquerda (Menu) */
        .sidebar { padding: 20px; position: sticky; top: 0; height: 100vh; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .logo { font-size: 2rem; font-weight: 800; color: var(--primary); margin-bottom: 30px; letter-spacing: -1px; }
        .nav-item { 
            font-size: 1.2rem; padding: 15px; border-radius: 30px; display: flex; align-items: center; gap: 15px; color: var(--text-main); font-weight: 600;
        }
        .nav-item:hover { background-color: rgba(15, 20, 25, 0.1); }
        .nav-item.active { font-weight: 800; color: var(--primary); }
        .nav-btn-action {
            background-color: var(--primary); color: white; width: 100%; padding: 15px; 
            border-radius: 30px; font-weight: 700; font-size: 1.1rem; margin-top: 20px; box-shadow: 0 4px 10px rgba(196, 23, 12, 0.3);
        }
        .nav-btn-action:hover { background-color: #a61209; }

        /* Feed Central */
        .main-feed { border-right: 1px solid var(--border); }
        .header-top {
            position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 100;
            border-bottom: 1px solid var(--border); padding: 10px 20px;
        }
        .filters { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .filter-tag {
            padding: 8px 16px; background: var(--gray); border-radius: 20px; font-size: 0.9rem; font-weight: 600; white-space: nowrap;
        }
        .filter-tag:hover, .filter-tag.active { background: var(--text-main); color: white; }

        /* Cards de Notícia */
        .news-card {
            padding: 20px; border-bottom: 1px solid var(--border); transition: 0.2s; cursor: pointer;
        }
        .news-card:hover { background-color: #f7f9f9; }
        .news-meta { display: flex; gap: 10px; font-size: 0.9rem; color: var(--text-sec); margin-bottom: 5px; align-items: center; }
        .news-author-img { width: 20px; height: 20px; border-radius: 50%; object-fit: cover; }
        .news-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 5px; line-height: 1.3; color: #000; }
        .news-subtitle { font-size: 1rem; color: var(--text-sec); margin-bottom: 10px; }
        .news-category { color: var(--primary); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        .news-actions { display: flex; justify-content: space-between; max-width: 400px; margin-top: 15px; color: var(--text-sec); }
        .action-btn { display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .action-btn:hover.red { color: var(--danger); }
        .action-btn:hover.blue { color: var(--secondary); }
        .action-btn:hover.green { color: var(--success); }
        .liked { color: var(--danger); }
        .reposted { color: var(--success); }

        /* Sidebar Direita (Widgets) */
        .widgets { padding: 20px; position: sticky; top: 0; }
        .search-box {
            background: var(--gray); padding: 12px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
        }
        .search-box input { border: none; background: transparent; padding: 0; width: 100%; font-weight: 500; }
        .search-box:focus-within { background: white; border: 1px solid var(--secondary); box-shadow: 0 0 5px rgba(29, 155, 240, 0.2); }
        
        .widget-box { background: var(--gray); border-radius: 16px; padding: 15px; margin-bottom: 20px; }
        .widget-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 15px; }

        /* Telas de Login / Admin */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .btn-primary {
            width: 100%; padding: 12px; background: var(--text-main); color: white; border-radius: 30px; font-weight: 700; margin-top: 10px;
        }
        .btn-primary:hover { background-color: var(--primary); }
        
        .btn-danger { background-color: var(--danger); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem;}

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 1000px) {
            .app-container { grid-template-columns: 80px 1fr; }
            .widgets { display: none; }
            .nav-text { display: none; }
            .logo { font-size: 1.5rem; text-align: center; }
        }
        @media (max-width: 600px) {
            .app-container { display: block; }
            .sidebar { 
                position: fixed; bottom: 0; top: auto; width: 100%; height: 60px; 
                flex-direction: row; justify-content: space-around; padding: 10px; background: white; border-top: 1px solid var(--border);
                z-index: 200;
            }
            .logo, .nav-btn-action { display: none; }
            .main-feed { padding-bottom: 70px; }
            .nav-item { padding: 10px; }
            .filter-tag { font-size: 0.8rem; padding: 6px 12px; }
        }
    </style>
</head>
<body>

<div id="auth-screen" style="display: flex; height: 100vh; align-items: center; justify-content: center; flex-direction: column; padding: 20px;">
    <h1 style="color: var(--primary); font-size: 3rem; margin-bottom: 20px;">g1 <span style="color: var(--text-main)">brookasil</span></h1>
    <div class="widget-box" style="width: 100%; max-width: 400px; background: white; border: 1px solid var(--border);">
        <h2 style="margin-bottom: 20px;">Entrar</h2>
        <input type="text" id="login-user" placeholder="@usuario ou Dono" class="form-group">
        <input type="password" id="login-pass" placeholder="Senha" class="form-group" style="margin-bottom: 15px;">
        <button class="btn-primary" onclick="app.auth.login()">Entrar</button>
        <p style="margin-top: 15px; text-align: center; font-size: 0.9rem;">
            Não tem conta? <a href="#" onclick="app.ui.toggleAuthMode()" style="color: var(--secondary)">Cadastre-se</a>
        </p>
    </div>
    <div id="register-box" class="widget-box" style="width: 100%; max-width: 400px; background: white; border: 1px solid var(--border); display: none;">
        <h2 style="margin-bottom: 20px;">Criar Conta</h2>
        <input type="text" id="reg-name" placeholder="Nome Completo" class="form-group">
        <input type="text" id="reg-user" placeholder="@usuario (sem espaços)" class="form-group">
        <input type="password" id="reg-pass" placeholder="Senha" class="form-group">
        <textarea id="reg-bio" placeholder="Biografia curta" class="form-group"></textarea>
        <button class="btn-primary" onclick="app.auth.register()">Criar Conta</button>
        <p style="margin-top: 15px; text-align: center; font-size: 0.9rem;">
            Já tem conta? <a href="#" onclick="app.ui.toggleAuthMode()" style="color: var(--secondary)">Entrar</a>
        </p>
    </div>
</div>

<div id="app-screen" class="app-container" style="display: none;">
    <aside class="sidebar">
        <div class="logo">g1 <span style="color: var(--text-main); font-weight: 300;">brookasil</span></div>
        <nav>
            <a onclick="app.router.go('home')" class="nav-item active" id="nav-home"><i class="fas fa-home"></i> <span class="nav-text">Início</span></a>
            <a onclick="app.router.go('explore')" class="nav-item" id="nav-explore"><i class="fas fa-hashtag"></i> <span class="nav-text">Explorar</span></a>
            <a onclick="app.router.go('profile')" class="nav-item" id="nav-profile"><i class="fas fa-user"></i> <span class="nav-text">Perfil</span></a>
            <a onclick="app.router.go('divulgacao')" class="nav-item" id="nav-divulga"><i class="fas fa-bullhorn"></i> <span class="nav-text">Divulgar</span></a>
            <a onclick="app.router.go('admin')" class="nav-item" id="nav-admin" style="display:none"><i class="fas fa-lock"></i> <span class="nav-text">Painel Dono</span></a>
            <a onclick="app.auth.logout()" class="nav-item"><i class="fas fa-sign-out-alt"></i> <span class="nav-text">Sair</span></a>
        </nav>
        <button class="nav-btn-action" onclick="app.ui.openPostModal()">Notícia</button>
    </aside>

    <main class="main-feed">
        <div class="header-top">
            <h2 id="page-title" style="margin-bottom: 10px;">Início</h2>
            <div class="filters" id="category-filters">
                <button onclick="app.news.filter('all')" class="filter-tag active">Todas</button>
                <button onclick="app.news.filter('Política')" class="filter-tag">Política</button>
                <button onclick="app.news.filter('Polícia')" class="filter-tag">Polícia</button>
                <button onclick="app.news.filter('Educação')" class="filter-tag">Educação</button>
                <button onclick="app.news.filter('Esporte')" class="filter-tag">Esporte</button>
                <button onclick="app.news.filter('Entretenimento')" class="filter-tag">Entretenimento</button>
            </div>
        </div>
        
        <div id="feed-loader" class="loader"></div>
        <div id="content-area">
            </div>
    </main>

    <aside class="widgets">
        <div class="search-box">
            <i class="fas fa-search" style="color: var(--text-sec)"></i>
            <input type="text" placeholder="Buscar no Brookasil" onkeyup="app.news.search(this.value)">
        </div>
        <div class="widget-box">
            <h3 class="widget-title">O que está acontecendo</h3>
            <p style="font-size: 0.9rem; color: var(--text-sec)">Notícias em tempo real com a credibilidade g1 e a velocidade do Twitter.</p>
        </div>
    </aside>
</div>

<div id="post-modal" class="modal">
    <div class="modal-content">
        <h2>Nova Notícia</h2>
        <input type="hidden" id="post-id">
        <div class="form-group"><label class="form-label">Título</label><input id="post-title"></div>
        <div class="form-group"><label class="form-label">Subtítulo</label><input id="post-subtitle"></div>
        <div class="form-group"><label class="form-label">Categoria</label>
            <select id="post-category">
                <option>Política</option><option>Polícia</option><option>Educação</option>
                <option>Esporte</option><option>Entretenimento</option><option>Curiosidades</option>
            </select>
        </div>
        <div class="form-group"><label class="form-label">Conteúdo</label><textarea id="post-content" rows="6"></textarea></div>
        <button class="btn-primary" onclick="app.news.save()">Publicar</button>
        <button class="btn-primary" onclick="app.ui.closeModals()" style="background: #ccc; color: #333; margin-top: 5px;">Cancelar</button>
    </div>
</div>

<div id="divulga-modal" class="modal">
    <div class="modal-content">
        <h2>Solicitar Divulgação</h2>
        <div class="form-group"><input id="div-title" placeholder="Título da Divulgação"></div>
        <div class="form-group"><textarea id="div-desc" placeholder="Descrição detalhada"></textarea></div>
        <div class="form-group">
            <select id="div-cat"><option>Evento</option><option>Serviço</option><option>Comércio</option></select>
        </div>
        <button class="btn-primary" onclick="app.divulga.submit()">Enviar Pedido</button>
        <button class="btn-primary" onclick="app.ui.closeModals()" style="background: #ccc; color: #333; margin-top: 5px;">Cancelar</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, update, remove, child, query, orderByChild, equalTo } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        databaseURL: "https://g1-brookasil-default-rtdb.firebaseio.com",
    };

    const appInstance = initializeApp(firebaseConfig);
    const db = getDatabase(appInstance);

    // ==========================================
    // APLICAÇÃO GERAL (Namespace 'app')
    // ==========================================
    window.app = {
        user: null, // Objeto do usuário logado
        
        // --- 1. AUTENTICAÇÃO ---
        auth: {
            async login() {
                const user = document.getElementById('login-user').value.trim();
                const pass = document.getElementById('login-pass').value.trim();
                
                if(!user || !pass) return alert("Preencha tudo");

                // Lógica Especial do Dono
                if (pass === 'Brookasil1234') {
                    // Login de Super Admin
                    const adminData = {
                        username: 'Dono',
                        name: 'Dono do Brookasil',
                        role: 'admin',
                        uid: 'admin_master_id',
                        avatar: 'https://ui-avatars.com/api/?name=Dono&background=c4170c&color=fff'
                    };
                    // Verifica se existe, senão cria
                    const snapshot = await get(child(ref(db), `users/${adminData.uid}`));
                    if (!snapshot.exists()) {
                        await set(ref(db, 'users/' + adminData.uid), adminData);
                    }
                    this.setSession(adminData);
                    return;
                }

                // Login Normal
                // Como Firebase Realtime não tem "Login" nativo sem Auth, buscamos o usuário pelo username
                // Nota: Em produção usaria Firebase Auth. Aqui usamos uma query manual.
                const usersRef = query(ref(db, 'users'), orderByChild('username'), equalTo(user));
                const snapshot = await get(usersRef);

                if (snapshot.exists()) {
                    const userData = Object.values(snapshot.val())[0];
                    if (userData.password === pass) {
                        this.setSession(userData);
                    } else {
                        alert("Senha incorreta");
                    }
                } else {
                    alert("Usuário não encontrado");
                }
            },

            async register() {
                const name = document.getElementById('reg-name').value;
                const user = document.getElementById('reg-user').value.replace(/\s/g, '').toLowerCase();
                const pass = document.getElementById('reg-pass').value;
                const bio = document.getElementById('reg-bio').value;

                if (!name || !user || !pass) return alert("Preencha os campos obrigatórios");

                // Verificar duplicidade
                const usersRef = query(ref(db, 'users'), orderByChild('username'), equalTo(user));
                const snapshot = await get(usersRef);

                if (snapshot.exists()) return alert("Usuário já existe! Escolha outro.");

                const newUserRef = push(ref(db, 'users'));
                const uid = newUserRef.key;
                const newUser = {
                    uid: uid,
                    name, username: user, password: pass, bio,
                    role: 'user', // Default
                    avatar: `https://ui-avatars.com/api/?name=${name}&background=random`
                };

                await set(newUserRef, newUser);
                alert("Conta criada! Faça login.");
                app.ui.toggleAuthMode();
            },

            setSession(userData) {
                app.user = userData;
                localStorage.setItem('brookasil_user', JSON.stringify(userData));
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'grid';
                app.init();
            },

            logout() {
                localStorage.removeItem('brookasil_user');
                location.reload();
            },

            check() {
                const stored = localStorage.getItem('brookasil_user');
                if (stored) {
                    app.user = JSON.parse(stored);
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-screen').style.display = 'grid';
                    app.init();
                }
            }
        },

        // --- 2. ROTEAMENTO ---
        router: {
            go(route) {
                // Atualiza UI da navbar
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navEl = document.getElementById('nav-' + route);
                if(navEl) navEl.classList.add('active');

                const content = document.getElementById('content-area');
                const title = document.getElementById('page-title');

                if (route === 'home') {
                    title.innerText = 'Início';
                    document.getElementById('category-filters').style.display = 'flex';
                    app.news.render();
                } else if (route === 'explore') {
                    title.innerText = 'Explorar';
                    content.innerHTML = '<div style="padding:20px; text-align:center">Utilize a barra de pesquisa para encontrar notícias.</div>';
                } else if (route === 'profile') {
                    title.innerText = 'Meu Perfil';
                    document.getElementById('category-filters').style.display = 'none';
                    app.ui.renderProfile(app.user);
                } else if (route === 'admin') {
                    if (app.user.role !== 'admin') return alert("Acesso Negado");
                    title.innerText = 'Painel do Dono';
                    document.getElementById('category-filters').style.display = 'none';
                    app.admin.render();
                } else if (route === 'divulgacao') {
                    title.innerText = 'Divulgações';
                    document.getElementById('category-filters').style.display = 'none';
                    app.divulga.render();
                }
            }
        },

        // --- 3. NOTÍCIAS ---
        news: {
            currentFilter: 'all',
            
            async render() {
                const loader = document.getElementById('feed-loader');
                const content = document.getElementById('content-area');
                loader.style.display = 'block';
                content.innerHTML = '';

                try {
                    const snapshot = await get(ref(db, 'news'));
                    if (!snapshot.exists()) {
                        content.innerHTML = '<p style="padding:20px">Nenhuma notícia ainda.</p>';
                        loader.style.display = 'none';
                        return;
                    }

                    let newsArr = [];
                    snapshot.forEach(child => {
                        newsArr.push({ id: child.key, ...child.val() });
                    });

                    // Ordenar por data (recente primeiro)
                    newsArr.sort((a, b) => b.timestamp - a.timestamp);

                    // Filtro
                    if (this.currentFilter !== 'all') {
                        newsArr = newsArr.filter(n => n.category === this.currentFilter);
                    }

                    // Renderizar
                    for (const news of newsArr) {
                        content.innerHTML += await app.ui.createNewsCard(news);
                    }
                } catch (e) {
                    console.error(e);
                } finally {
                    loader.style.display = 'none';
                }
            },

            filter(category) {
                this.currentFilter = category;
                document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                this.render();
            },

            async save() {
                const title = document.getElementById('post-title').value;
                const subtitle = document.getElementById('post-subtitle').value;
                const category = document.getElementById('post-category').value;
                const content = document.getElementById('post-content').value;
                const id = document.getElementById('post-id').value; // Se tiver ID é edição

                if (!title || !content) return alert("Título e Conteúdo obrigatórios");

                const newsData = {
                    title, subtitle, category, content,
                    author: app.user.name,
                    authorId: app.user.uid,
                    authorUser: app.user.username,
                    timestamp: Date.now(),
                    likes: 0
                };

                if (id) {
                    // Edição (Dono ou próprio autor)
                    await update(ref(db, 'news/' + id), newsData);
                } else {
                    // Criação
                    await push(ref(db, 'news'), newsData);
                }

                app.ui.closeModals();
                app.news.render();
            },

            async delete(id) {
                if(!confirm("Tem certeza que deseja apagar?")) return;
                await remove(ref(db, 'news/' + id));
                // Apagar interações relacionadas (opcional para limpar DB)
                app.news.render();
            },

            async search(term) {
                if (term.length < 3) return;
                // Busca simples client-side pois Firebase puro tem busca limitada
                const content = document.getElementById('content-area');
                content.innerHTML = '<div class="loader" style="display:block"></div>';
                
                const snapshot = await get(ref(db, 'news'));
                let results = [];
                snapshot.forEach(c => {
                    const n = c.val();
                    if (n.title.toLowerCase().includes(term.toLowerCase()) || 
                        n.content.toLowerCase().includes(term.toLowerCase())) {
                        results.push({id: c.key, ...n});
                    }
                });

                content.innerHTML = '';
                if(results.length === 0) content.innerHTML = '<p style="padding:20px">Nada encontrado.</p>';
                for (const news of results) {
                    content.innerHTML += await app.ui.createNewsCard(news);
                }
            }
        },

        // --- 4. INTERAÇÕES ---
        interactions: {
            async toggleLike(newsId) {
                // Verificar se já curtiu
                const likeRef = ref(db, `likes/${newsId}/${app.user.uid}`);
                const snapshot = await get(likeRef);
                const newsRef = ref(db, `news/${newsId}`);
                
                // Pega contagem atual
                const nSnap = await get(newsRef);
                let currentCount = nSnap.val().likes || 0;

                if (snapshot.exists()) {
                    // Descurtir
                    await remove(likeRef);
                    await update(newsRef, { likes: currentCount - 1 });
                } else {
                    // Curtir
                    await set(likeRef, true);
                    await update(newsRef, { likes: currentCount + 1 });
                }
                
                // Atualizar UI pontualmente
                const btn = document.getElementById(`like-btn-${newsId}`);
                const count = document.getElementById(`like-count-${newsId}`);
                if (snapshot.exists()) {
                    btn.classList.remove('liked');
                    btn.innerHTML = '<i class="far fa-heart"></i>';
                    count.innerText = currentCount - 1;
                } else {
                    btn.classList.add('liked');
                    btn.innerHTML = '<i class="fas fa-heart"></i>';
                    count.innerText = currentCount + 1;
                }
            },

            async repost(newsId) {
                const repostRef = ref(db, `reposts/${app.user.uid}/${newsId}`);
                await set(repostRef, { timestamp: Date.now() });
                alert("Republicado no seu perfil!");
            },
            
            async copyLink(newsId) {
                // Simulação de link
                const url = window.location.origin + "/#news=" + newsId;
                navigator.clipboard.writeText(url);
                alert("Link copiado!");
            }
        },

        // --- 5. ADMIN / DONO ---
        admin: {
            async render() {
                const content = document.getElementById('content-area');
                content.innerHTML = `
                    <div style="padding: 20px;">
                        <h3 style="margin-bottom: 20px;">Gerenciamento Global</h3>
                        <div class="filter-tag active" style="margin-bottom:20px; display:inline-block">Jornalistas e Notícias</div>
                        <div id="admin-news-list"></div>
                        <h3 style="margin: 20px 0;">Divulgações Pendentes</h3>
                        <div id="admin-divulga-list"></div>
                    </div>
                `;

                // Carregar todas as notícias para edição/exclusão
                const snapNews = await get(ref(db, 'news'));
                const list = document.getElementById('admin-news-list');
                
                if(snapNews.exists()) {
                    snapNews.forEach(c => {
                        const n = c.val();
                        list.innerHTML += `
                            <div style="padding: 10px; border: 1px solid #eee; margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <b>${n.title}</b><br>
                                    <small>Por: ${n.author}</small>
                                </div>
                                <div>
                                    <button onclick="app.ui.openPostModal('${c.key}')" class="btn-danger" style="background:#ddd; color:#333"><i class="fas fa-pen"></i></button>
                                    <button onclick="app.news.delete('${c.key}')" class="btn-danger"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `;
                    });
                }

                // Carregar Divulgações Pendentes
                const snapDiv = await get(query(ref(db, 'divulgacoes'), orderByChild('status'), equalTo('pendente')));
                const divList = document.getElementById('admin-divulga-list');
                if(!snapDiv.exists()) divList.innerHTML = '<p>Nenhuma pendente.</p>';
                
                snapDiv.forEach(c => {
                    const d = c.val();
                    divList.innerHTML += `
                        <div style="padding: 10px; background: #fff3cd; border-radius: 8px; margin-bottom: 10px;">
                            <h4>${d.title}</h4>
                            <p>${d.desc}</p>
                            <small>Solicitado por: ${d.username}</small>
                            <div style="margin-top:10px;">
                                <button onclick="app.divulga.approve('${c.key}', true)" style="color:green; font-weight:bold; margin-right:10px">APROVAR</button>
                                <button onclick="app.divulga.approve('${c.key}', false)" style="color:red; font-weight:bold">REPROVAR</button>
                            </div>
                        </div>
                    `;
                });
            }
        },

        // --- 6. DIVULGAÇÃO ---
        divulga: {
            render() {
                const content = document.getElementById('content-area');
                content.innerHTML = `
                    <div style="padding: 20px; text-align: center">
                        <button class="nav-btn-action" onclick="document.getElementById('divulga-modal').style.display='flex'">Solicitar Nova Divulgação</button>
                        <hr style="margin: 20px 0; border-top: 1px solid #eee;">
                        <h3>Mural de Divulgações</h3>
                    </div>
                    <div id="mural-divulga"></div>
                `;
                this.loadMural();
            },
            
            async loadMural() {
                 const snap = await get(query(ref(db, 'divulgacoes'), orderByChild('status'), equalTo('aprovado')));
                 const mural = document.getElementById('mural-divulga');
                 if(!snap.exists()) {
                     mural.innerHTML = '<p style="text-align:center; color:#777">Nenhuma divulgação ativa.</p>';
                     return;
                 }
                 snap.forEach(c => {
                     const d = c.val();
                     mural.innerHTML += `
                        <div class="news-card" style="background: #f0f7ff; border-left: 4px solid var(--secondary)">
                            <div class="news-category" style="color: var(--secondary)">${d.category}</div>
                            <div class="news-title">${d.title}</div>
                            <div class="news-subtitle">${d.desc}</div>
                            <small>Anunciante: @${d.username}</small>
                        </div>
                     `;
                 });
            },

            async submit() {
                const title = document.getElementById('div-title').value;
                const desc = document.getElementById('div-desc').value;
                const cat = document.getElementById('div-cat').value;
                
                await push(ref(db, 'divulgacoes'), {
                    title, desc, category: cat,
                    status: 'pendente',
                    userId: app.user.uid,
                    username: app.user.username,
                    timestamp: Date.now()
                });
                alert("Solicitação enviada! Aguarde aprovação do Dono.");
                app.ui.closeModals();
            },

            async approve(id, isApproved) {
                await update(ref(db, 'divulgacoes/' + id), {
                    status: isApproved ? 'aprovado' : 'reprovado'
                });
                app.admin.render(); // Refresh
            }
        },

        // --- UI HELPERS ---
        ui: {
            toggleAuthMode() {
                const loginBox = document.querySelector('#auth-screen .widget-box:nth-child(2)');
                const regBox = document.getElementById('register-box');
                if(loginBox.style.display !== 'none') {
                    loginBox.style.display = 'none';
                    regBox.style.display = 'block';
                } else {
                    loginBox.style.display = 'block';
                    regBox.style.display = 'none';
                }
            },

            async createNewsCard(news) {
                // Verificar se o usuário atual deu like
                let liked = false;
                try {
                    const lSnap = await get(ref(db, `likes/${news.id}/${app.user.uid}`));
                    if(lSnap.exists()) liked = true;
                } catch(e){}

                // Verificar se é dono ou autor para mostrar botão editar
                let editBtn = '';
                if(app.user.role === 'admin' || app.user.uid === news.authorId) {
                    editBtn = `<button onclick="app.ui.openPostModal('${news.id}')" style="margin-left: auto; color: var(--text-sec)"><i class="fas fa-ellipsis-h"></i></button>`;
                }

                // Gerar Avatar fake based on name
                const avatar = `https://ui-avatars.com/api/?name=${news.author}&background=random&size=32`;

                return `
                <article class="news-card">
                    <div class="news-meta">
                        <img src="${avatar}" class="news-author-img">
                        <span style="font-weight: 700; color: #0f1419;">${news.author}</span>
                        <span>@${news.authorUser || 'jornalista'}</span>
                        <span>·</span>
                        <span>${new Date(news.timestamp).toLocaleDateString()}</span>
                        ${editBtn}
                    </div>
                    <div class="news-category">${news.category}</div>
                    <h3 class="news-title">${news.title}</h3>
                    <p class="news-subtitle">${news.subtitle}</p>
                    <p style="margin-top:10px; white-space: pre-wrap;">${news.content}</p>
                    
                    <div class="news-actions">
                        <button class="action-btn blue" onclick="alert('Comentários em desenvolvimento')">
                            <i class="far fa-comment"></i> <span>0</span>
                        </button>
                        <button class="action-btn green" onclick="app.interactions.repost('${news.id}')">
                            <i class="fas fa-retweet"></i>
                        </button>
                        <button id="like-btn-${news.id}" class="action-btn red ${liked ? 'liked' : ''}" onclick="app.interactions.toggleLike('${news.id}')">
                            ${liked ? '<i class="fas fa-heart"></i>' : '<i class="far fa-heart"></i>'}
                            <span id="like-count-${news.id}">${news.likes || 0}</span>
                        </button>
                        <button class="action-btn blue" onclick="app.interactions.copyLink('${news.id}')">
                            <i class="fas fa-share-square"></i>
                        </button>
                    </div>
                </article>
                `;
            },

            async renderProfile(userData) {
                const content = document.getElementById('content-area');
                
                content.innerHTML = `
                    <div style="background: #cfd9de; height: 150px;"></div>
                    <div style="padding: 20px; position: relative;">
                        <img src="${userData.avatar}" style="width: 130px; height: 130px; border-radius: 50%; border: 4px solid white; position: absolute; top: -65px;">
                        <div style="text-align: right;">
                            <button onclick="alert('Editar Perfil em desenvolvimento')" style="border: 1px solid #cfd9de; padding: 8px 16px; border-radius: 20px; font-weight: bold;">Editar Perfil</button>
                        </div>
                        <h2 style="margin-top: 10px; font-weight: 800;">${userData.name}</h2>
                        <div style="color: var(--text-sec)">@${userData.username}</div>
                        <p style="margin-top: 10px;">${userData.bio || 'Sem biografia.'}</p>
                        <div style="margin-top: 10px; color: var(--text-sec);"><i class="far fa-calendar-alt"></i> Usuário do Brookasil</div>
                    </div>
                    <hr style="border: 0; border-top: 1px solid var(--border)">
                    <div style="padding: 20px; font-weight: 800; border-bottom: 2px solid var(--primary); display: inline-block;">Republicações</div>
                    <div id="profile-reposts"></div>
                `;

                // Carregar Reposts
                const repostsSnap = await get(ref(db, `reposts/${userData.uid}`));
                const repostList = document.getElementById('profile-reposts');
                
                if(!repostsSnap.exists()) {
                    repostList.innerHTML = '<p style="padding:20px; color:#777">Nenhuma republicação.</p>';
                    return;
                }

                repostsSnap.forEach(async (c) => {
                    const newsId = c.key;
                    const newsSnap = await get(ref(db, `news/${newsId}`));
                    if(newsSnap.exists()) {
                        const card = await app.ui.createNewsCard({id: newsId, ...newsSnap.val()});
                        repostList.innerHTML += `<div style="padding: 10px; font-size: 0.8rem; color: var(--text-sec)"><i class="fas fa-retweet"></i> Republicado</div>` + card;
                    }
                });
            },

            async openPostModal(editId = null) {
                const modal = document.getElementById('post-modal');
                const title = modal.querySelector('h2');
                
                // Limpar campos
                document.getElementById('post-id').value = '';
                document.getElementById('post-title').value = '';
                document.getElementById('post-subtitle').value = '';
                document.getElementById('post-content').value = '';

                if (editId) {
                    title.innerText = "Editar Notícia";
                    const snap = await get(ref(db, `news/${editId}`));
                    if (snap.exists()) {
                        const data = snap.val();
                        document.getElementById('post-id').value = editId;
                        document.getElementById('post-title').value = data.title;
                        document.getElementById('post-subtitle').value = data.subtitle;
                        document.getElementById('post-content').value = data.content;
                        document.getElementById('post-category').value = data.category;
                    }
                } else {
                    title.innerText = "Nova Notícia";
                    if (app.user.role !== 'admin' && app.user.role !== 'journalist') {
                        // Verifica se user comum pode postar? Regra diz: Dono e Jornalista.
                        // Mas vou permitir ao Dono adicionar jornalistas depois. 
                        // Por padrão, se for "user", bloqueia.
                        if (app.user.role === 'user') return alert("Apenas jornalistas podem postar.");
                    }
                }
                modal.style.display = 'flex';
            },

            closeModals() {
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            }
        },

        init() {
            if (app.user.role === 'admin') {
                document.getElementById('nav-admin').style.display = 'flex';
            }
            app.router.go('home');
        }
    };

    // Inicialização
    app.auth.check();

</script>
</body>
</html>
