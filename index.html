<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>g1 Brookasil - O portal de notícias</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;500;700&family=Inter:wght@300;400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- RESET & VARIAVEIS --- */
        :root {
            --g1-red: #c4170c;
            --g1-dark-red: #a6120a;
            --g1-gray: #333333;
            --g1-light-gray: #f7f7f7;
            --g1-border: #e6e6e6;
            --g1-text: #222222;
            --g1-meta: #666666;
            --twitter-blue: #1d9bf0;
            --twitter-like: #f91880;
            --twitter-retweet: #00ba7c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body {
            font-family: 'Arimo', sans-serif;
            background-color: #fff;
            color: var(--g1-text);
            overflow-x: hidden;
        }
        a { text-decoration: none; color: inherit; cursor: pointer; }
        ul { list-style: none; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--g1-red); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .splash-logo { font-family: 'Inter', sans-serif; font-weight: 800; font-size: 4rem; color: #fff; letter-spacing: -2px; }
        .splash-loader {
            width: 200px; height: 4px; background: rgba(255,255,255,0.3); margin-top: 20px; border-radius: 2px; overflow: hidden;
        }
        .splash-bar {
            width: 0%; height: 100%; background: #fff; transition: width 0.2s;
        }
        .splash-text { color: #fff; margin-top: 10px; font-size: 0.9rem; }

        /* --- HEADER --- */
        header { background: var(--g1-red); height: 56px; display: flex; align-items: center; justify-content: space-between; padding: 0 5%; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .menu-btn { color: #fff; font-size: 1.5rem; }
        .logo-g1 { font-family: 'Inter', sans-serif; font-weight: 800; font-size: 2rem; color: #fff; letter-spacing: -2px; line-height: 1; }
        .logo-suffix { font-weight: 300; font-size: 1.2rem; margin-left: 2px; opacity: 0.9; }
        
        .header-search { flex: 1; max-width: 600px; margin: 0 20px; position: relative; display: none; }
        @media(min-width: 768px) { .header-search { display: block; } }
        .search-input { width: 100%; padding: 8px 15px; border-radius: 4px; border: none; background: rgba(255,255,255,0.2); color: #fff; transition: 0.3s; }
        .search-input::placeholder { color: rgba(255,255,255,0.7); }
        .search-input:focus { background: #fff; color: #333; }
        
        .header-right { display: flex; align-items: center; gap: 15px; color: #fff; font-size: 0.8rem; }
        .user-avatar-mini { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #fff; cursor: pointer; }
        .weather-widget { text-align: right; display: none; }
        @media(min-width: 768px) { .weather-widget { display: block; } }

        /* --- MENU LATERAL --- */
        #sidebar {
            position: fixed; top: 0; left: -300px; width: 280px; height: 100%;
            background: #fff; z-index: 1001; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        }
        #sidebar.open { left: 0; }
        .sidebar-header { height: 56px; background: var(--g1-red); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: #fff; }
        .sidebar-menu { overflow-y: auto; flex: 1; padding: 10px 0; }
        .sidebar-item { padding: 12px 20px; font-weight: 700; color: var(--g1-g1-red); font-size: 0.95rem; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .sidebar-item:hover { background: #f9f9f9; color: var(--g1-red); }
        .sidebar-item i { width: 20px; text-align: center; color: #999; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }

        /* --- LAYOUT PRINCIPAL --- */
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; min-height: 80vh; }
        
        /* Grid de Notícias */
        .feed-grid { display: grid; gap: 30px; grid-template-columns: 1fr; }
        @media(min-width: 768px) { .feed-grid { grid-template-columns: repeat(3, 1fr); } }
        
        /* Card G1 Style */
        .card { display: flex; flex-direction: column; gap: 10px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .card:hover .card-title { color: var(--g1-red); }
        .card-img-wrapper { width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 4px; background: #eee; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .card:hover .card-img { transform: scale(1.05); }
        .card-theme { color: var(--g1-red); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        .card-title { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 1.4rem; line-height: 1.2; color: #333; }
        .card-subtitle { font-size: 1rem; color: #666; line-height: 1.4; }
        .card-meta { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }

        /* Destaque Principal (Hero) */
        .hero-card { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 30px; }
        @media(min-width: 768px) { 
            .hero-card { grid-template-columns: 1.5fr 1fr; } 
            .hero-content { order: 1; } .hero-image { order: 2; }
        }
        .hero-title { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; color: var(--g1-red); line-height: 1.1; margin-bottom: 10px; }
        .hero-subtitle { font-size: 1.2rem; color: #444; }

        /* --- PÁGINA DE NOTÍCIA (DETALHE) --- */
        #article-view { display: none; animation: fadeIn 0.3s; }
        .article-header { margin-bottom: 30px; text-align: center; max-width: 800px; margin: 0 auto 30px; }
        .article-h1 { font-size: 2.8rem; font-weight: 800; line-height: 1.1; margin-bottom: 15px; color: #111; }
        .article-h2 { font-size: 1.3rem; font-weight: 400; color: #555; line-height: 1.4; }
        .article-meta-bar { border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 15px 0; margin: 20px auto; max-width: 800px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #666; }
        .article-body { max-width: 800px; margin: 0 auto; font-size: 1.2rem; line-height: 1.8; color: #222; }
        .article-body p { margin-bottom: 20px; }
        .article-body img { max-width: 100%; height: auto; border-radius: 4px; margin: 20px 0; }

        /* --- INTERAÇÕES SOCIAIS --- */
        .social-bar { display: flex; gap: 20px; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; max-width: 800px; margin-left: auto; margin-right: auto; }
        .social-btn { display: flex; align-items: center; gap: 8px; font-size: 1rem; color: #555; padding: 8px 16px; border-radius: 20px; transition: 0.2s; }
        .social-btn:hover { background: rgba(0,0,0,0.05); }
        .social-btn.liked { color: var(--twitter-like); }
        .social-btn.reposted { color: var(--twitter-retweet); }
        
        /* Comentários */
        .comments-section { max-width: 800px; margin: 40px auto; background: #f9f9f9; padding: 20px; border-radius: 8px; }
        .comment-input-area { display: flex; gap: 10px; margin-bottom: 20px; }
        .comment-box { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; min-height: 60px; }
        .btn-comment { background: var(--twitter-blue); color: #fff; padding: 0 20px; border-radius: 20px; font-weight: 700; }
        .comment-list { display: flex; flex-direction: column; gap: 15px; }
        .comment-item { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; display: flex; gap: 10px; }
        .comment-content { flex: 1; }
        .comment-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; }
        .comment-author { font-weight: 700; }
        .comment-date { color: #999; }

        /* --- AUTH & FORMS --- */
        .auth-container { max-width: 400px; margin: 50px auto; padding: 30px; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-primary { width: 100%; padding: 12px; background: var(--g1-red); color: #fff; font-weight: 700; border-radius: 4px; }
        .btn-secondary { background: #666; margin-top: 10px; }

        /* --- PAINEL (Admin/Jornalista) --- */
        #admin-panel { display: none; background: #fff; padding: 20px; }
        .admin-toolbar { background: #f0f0f0; padding: 15px; margin-bottom: 20px; border-radius: 4px; display: flex; gap: 10px; flex-wrap: wrap; }
        .editor-container input, .editor-container textarea, .editor-container select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; display: block; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: #fff; font-weight: bold; margin-left: 5px; }
        .badge-owner { background: #000; }
        .badge-journ { background: var(--twitter-blue); }
        .feed-alert { text-align: center; padding: 40px; color: #666; width: 100%; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">g1 <span style="font-weight:300">brookasil</span></div>
        <div class="splash-loader"><div class="splash-bar" id="splash-bar"></div></div>
        <p class="splash-text">Carregando notícias...</p>
    </div>

    <div id="overlay" onclick="toggleMenu()"></div>

    <aside id="sidebar">
        <div class="sidebar-header">
            <span>MENU</span>
            <button onclick="toggleMenu()" style="color:white;"><i class="fas fa-times"></i></button>
        </div>
        <ul class="sidebar-menu" id="menu-list">
            </ul>
    </aside>

    <header>
        <div class="header-left">
            <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
            <div class="logo-g1" onclick="router('home')" style="cursor:pointer;">
                g1<span class="logo-suffix">brookasil</span>
            </div>
        </div>
        
        <div class="header-search">
            <input type="text" class="search-input" placeholder="Buscar no g1..." id="search-box" onkeyup="handleSearch(event)">
        </div>

        <div class="header-right">
            <div class="weather-widget">
                <span id="clock-display">--:--</span> | <span style="color:#ffcc00"><i class="fas fa-sun"></i> 29°C</span>
                <div style="font-size: 0.7rem; opacity: 0.8;">Maceió, AL</div>
            </div>
            <img id="header-avatar" src="https://via.placeholder.com/32" class="user-avatar-mini" onclick="handleProfileClick()">
        </div>
    </header>

    <main id="app-container">
        </main>

    <script>
        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            databaseURL: "https://g1-brookasil-default-rtdb.firebaseio.com",
            // A chave API é usada para autenticação interna do SDK, mas para RTDB público/regras simples, a URL basta.
            // Para cumprir o prompt, vamos apenas inicializar.
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // --- ESTADO GLOBAL ---
        const state = {
            currentUser: null, // { uid, username, role, avatar, name }
            view: 'home',
            news: [],
            users: {},
            loading: true
        };

        // --- UTILITÁRIOS ---
        const $ = (s) => document.querySelector(s);
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const escapeHtml = (text) => {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        };
        const getAlagoasTime = () => {
            return new Date().toLocaleTimeString('pt-BR', { timeZone: 'America/Maceio' });
        };
        
        // --- INICIALIZAÇÃO ---
        window.onload = async () => {
            simulateLoading();
            startClock();
            loadSession();
            await fetchInitialData();
        };

        function simulateLoading() {
            let width = 0;
            const bar = $('#splash-bar');
            const interval = setInterval(() => {
                width += Math.random() * 10;
                if(width >= 100) {
                    width = 100;
                    clearInterval(interval);
                    setTimeout(() => {
                        $('#splash-screen').style.opacity = '0';
                        setTimeout(() => $('#splash-screen').style.display = 'none', 500);
                        router('home');
                    }, 500);
                }
                bar.style.width = width + '%';
            }, 100);
        }

        function startClock() {
            setInterval(() => {
                $('#clock-display').innerText = getAlagoasTime();
            }, 1000);
        }

        // --- FIREBASE DATA ---
        async function fetchInitialData() {
            // Listen to News
            db.ref('news').on('value', (snapshot) => {
                const data = snapshot.val();
                state.news = data ? Object.values(data) : [];
                if(state.view === 'home') renderHome();
            });

            // Listen to Users (Simples cache para performance)
            db.ref('users').on('value', (snapshot) => {
                state.users = snapshot.val() || {};
            });
        }

        // --- SISTEMA DE ROTEAMENTO ---
        function router(view, params = null) {
            state.view = view;
            const container = $('#app-container');
            container.innerHTML = ''; // Limpa tela
            toggleMenu(false); // Fecha menu se aberto

            switch(view) {
                case 'home':
                    renderHome(params); // params pode ser filtro de categoria
                    break;
                case 'article':
                    renderArticle(params); // params é o ID da notícia
                    break;
                case 'login':
                    renderLogin();
                    break;
                case 'register':
                    renderRegister();
                    break;
                case 'profile':
                    renderProfile();
                    break;
                case 'editor':
                    renderEditor(params); // params pode ser ID para editar
                    break;
                case 'search':
                    renderSearch(params); // params é o termo
                    break;
                case 'divulgacao':
                    renderDivulgacao();
                    break;
                default:
                    renderHome();
            }
            updateHeaderState();
        }

        // --- COMPONENTES UI ---

        function updateHeaderState() {
            const avatar = $('#header-avatar');
            if (state.currentUser) {
                avatar.src = state.currentUser.avatar || 'https://via.placeholder.com/32';
                avatar.style.border = '2px solid white';
            } else {
                avatar.src = 'https://via.placeholder.com/32?text=?';
            }
        }

        function toggleMenu(forceClose) {
            const sidebar = $('#sidebar');
            const overlay = $('#overlay');
            if (forceClose === false || sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.style.display = 'none';
            } else {
                renderMenuLinks();
                sidebar.classList.add('open');
                overlay.style.display = 'block';
            }
        }

        function renderMenuLinks() {
            const list = $('#menu-list');
            list.innerHTML = '';
            
            const categories = [
                {name: 'Home', icon: 'fa-home', action: () => router('home')},
                {name: 'Destaques', icon: 'fa-star', action: () => router('home', 'Destaque')},
                {name: 'Política', icon: 'fa-landmark', action: () => router('home', 'Política')},
                {name: 'Polícia', icon: 'fa-gavel', action: () => router('home', 'Polícia')},
                {name: 'Educação', icon: 'fa-graduation-cap', action: () => router('home', 'Educação')},
                {name: 'Esporte', icon: 'fa-futbol', action: () => router('home', 'Esporte')},
                {name: 'Entretenimento', icon: 'fa-film', action: () => router('home', 'Entretenimento')},
                {name: 'Divulgação de Trabalho', icon: 'fa-briefcase', action: () => router('divulgacao')},
            ];

            // Itens de Usuário
            if (state.currentUser) {
                categories.push({name: 'Minha Conta', icon: 'fa-user', action: () => router('profile')});
                if (state.currentUser.role === 'owner' || state.currentUser.role === 'journalist') {
                    categories.push({name: 'Escrever Notícia', icon: 'fa-pen', action: () => router('editor')});
                }
                categories.push({name: 'Sair', icon: 'fa-sign-out-alt', action: logout});
            } else {
                categories.push({name: 'Entrar / Cadastrar', icon: 'fa-user-circle', action: () => router('login')});
            }

            categories.forEach(item => {
                const li = document.createElement('li');
                li.className = 'sidebar-item';
                li.innerHTML = `<i class="fas ${item.icon}"></i> ${item.name}`;
                li.onclick = item.action;
                list.appendChild(li);
            });
        }

        // --- RENDERIZADORES ---

        function renderHome(categoryFilter = null) {
            const container = $('#app-container');
            let content = '';

            // Filtrar e Ordenar (Mais recente primeiro)
            let posts = state.news.sort((a,b) => new Date(b.date) - new Date(a.date));
            if (categoryFilter) {
                posts = posts.filter(p => p.theme === categoryFilter || (categoryFilter === 'Destaque' && p.isHighlight));
                content += `<h2 style="color:var(--g1-red); margin: 20px 0;">${categoryFilter}</h2>`;
            }

            if (posts.length === 0) {
                container.innerHTML = `<div class="feed-alert">Nenhuma notícia encontrada nesta seção.</div>`;
                return;
            }

            content += `<div class="feed-grid">`;
            
            // Logic para Destaque Principal (Primeiro item se for Home)
            posts.forEach((post, index) => {
                const isHero = index === 0 && !categoryFilter;
                const cssClass = isHero ? 'hero-card' : 'card';
                
                content += `
                <div class="${cssClass}" onclick="router('article', '${post.id}')">
                    <div class="card-img-wrapper ${isHero ? 'hero-image' : ''}">
                        <img src="${post.image}" class="card-img" onerror="this.src='https://via.placeholder.com/800x450?text=Sem+Imagem'">
                    </div>
                    <div class="${isHero ? 'hero-content' : ''}">
                        <div class="card-theme">${post.theme}</div>
                        <h2 class="${isHero ? 'hero-title' : 'card-title'}">${post.title}</h2>
                        <p class="${isHero ? 'hero-subtitle' : 'card-subtitle'}">${post.subtitle}</p>
                        <div class="card-meta">
                            <span>${getTimeAgo(post.date)}</span>
                            ${post.authorName ? `<span>Por ${post.authorName}</span>` : ''}
                        </div>
                    </div>
                </div>
                `;
            });
            content += `</div>`;
            container.innerHTML = content;
        }

        function renderArticle(newsId) {
            const post = state.news.find(n => n.id === newsId);
            if (!post) return router('home');

            const container = $('#app-container');
            
            // Layout da Notícia
            container.innerHTML = `
                <div id="article-view">
                    <div class="article-header">
                        <h1 class="article-h1">${post.title}</h1>
                        <h2 class="article-h2">${post.subtitle}</h2>
                        <div class="article-meta-bar">
                            <div>
                                <strong>Por ${post.authorName || 'Redação'}</strong>, g1 Brookasil<br>
                                ${new Date(post.date).toLocaleDateString()} às ${new Date(post.date).toLocaleTimeString()}
                            </div>
                            <div class="share-btns">
                                <button onclick="shareLink()"><i class="fas fa-link"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="article-body">
                        <img src="${post.image}" style="width:100%">
                        ${formatArticleBody(post.content)}
                    </div>

                    <div class="social-bar">
                        <button class="social-btn" id="btn-like" onclick="handleInteraction('${post.id}', 'like')">
                            <i class="far fa-heart"></i> <span id="like-count">0</span>
                        </button>
                        <button class="social-btn" id="btn-repost" onclick="handleInteraction('${post.id}', 'repost')">
                            <i class="fas fa-retweet"></i> Republicar
                        </button>
                    </div>

                    <div class="comments-section">
                        <h3>Comentários</h3>
                        ${state.currentUser ? `
                        <div class="comment-input-area">
                            <img src="${state.currentUser.avatar}" class="user-avatar-mini">
                            <textarea id="comment-text" class="comment-box" placeholder="Escreva um comentário estilo Twitter..."></textarea>
                            <button class="btn-comment" onclick="submitComment('${post.id}')">Tweetar</button>
                        </div>` : `<p><a onclick="router('login')" style="color:blue">Faça login</a> para comentar.</p>`}
                        
                        <div id="comments-list" class="comment-list">
                            </div>
                    </div>
                </div>
            `;

            loadInteractions(post.id);
        }

        // --- SISTEMA DE INTERAÇÕES ---

        function loadInteractions(newsId) {
            // Carregar Likes
            db.ref(`likes/${newsId}`).on('value', snap => {
                const likes = snap.val() || {};
                const count = Object.keys(likes).length;
                const btn = $('#btn-like');
                if(btn) {
                    $('#like-count').innerText = count;
                    if(state.currentUser && likes[state.currentUser.uid]) {
                        btn.classList.add('liked');
                        btn.innerHTML = `<i class="fas fa-heart"></i> <span id="like-count">${count}</span>`;
                    } else {
                        btn.classList.remove('liked');
                        btn.innerHTML = `<i class="far fa-heart"></i> <span id="like-count">${count}</span>`;
                    }
                }
            });

            // Carregar Comentários
            db.ref(`comments/${newsId}`).on('value', snap => {
                const list = $('#comments-list');
                if(!list) return;
                list.innerHTML = '';
                const comments = snap.val();
                if(comments) {
                    Object.values(comments).forEach(c => {
                        const canDelete = state.currentUser && (state.currentUser.role === 'owner' || state.currentUser.uid === c.userId);
                        list.innerHTML += `
                            <div class="comment-item">
                                <img src="${c.userAvatar}" class="user-avatar-mini">
                                <div class="comment-content">
                                    <div class="comment-header">
                                        <div><span class="comment-author">@${c.username}</span> • <span class="comment-date">${getTimeAgo(c.date)}</span></div>
                                        ${canDelete ? `<button onclick="deleteComment('${newsId}', '${c.id}')" style="color:red; font-size:0.8rem;"><i class="fas fa-trash"></i></button>` : ''}
                                    </div>
                                    <div>${escapeHtml(c.text)}</div>
                                </div>
                            </div>
                        `;
                    });
                }
            });
        }

        function handleInteraction(newsId, type) {
            if(!state.currentUser) return router('login');
            
            if(type === 'like') {
                const ref = db.ref(`likes/${newsId}/${state.currentUser.uid}`);
                ref.once('value', snap => {
                    if(snap.exists()) ref.remove(); // Descurtir
                    else ref.set(true); // Curtir
                });
            } else if (type === 'repost') {
                 // Simplificação: Repost apenas salva no perfil do usuário
                 alert('Notícia republicada no seu perfil!');
            }
        }

        function submitComment(newsId) {
            const text = $('#comment-text').value.trim();
            if(!text) return;
            
            const commentId = generateId();
            db.ref(`comments/${newsId}/${commentId}`).set({
                id: commentId,
                userId: state.currentUser.uid,
                username: state.currentUser.username,
                userAvatar: state.currentUser.avatar,
                text: text,
                date: new Date().toISOString()
            });
            $('#comment-text').value = '';
        }
        
        function deleteComment(newsId, commentId) {
            if(confirm('Apagar comentário?')) {
                db.ref(`comments/${newsId}/${commentId}`).remove();
            }
        }

        // --- AUTH & USER ---

        function renderLogin() {
            $('#app-container').innerHTML = `
                <div class="auth-container">
                    <h2 style="margin-bottom:20px; color: var(--g1-red);">Entrar no g1 Brookasil</h2>
                    <input type="text" id="login-user" class="auth-input" placeholder="@usuario (sem @)">
                    <input type="password" id="login-pass" class="auth-input" placeholder="Senha">
                    <button class="btn-primary" onclick="attemptLogin()">Entrar</button>
                    <button class="btn-secondary" style="width:100%" onclick="router('register')">Criar Conta</button>
                </div>
            `;
        }

        function renderRegister() {
            $('#app-container').innerHTML = `
                <div class="auth-container">
                    <h2 style="margin-bottom:20px; color: var(--g1-red);">Criar Conta</h2>
                    <input type="text" id="reg-name" class="auth-input" placeholder="Nome Completo">
                    <input type="text" id="reg-user" class="auth-input" placeholder="@usuario (único)">
                    <input type="password" id="reg-pass" class="auth-input" placeholder="Senha">
                    <label style="display:block; text-align:left; font-size:0.8rem; margin-bottom:5px;">Foto de Perfil</label>
                    <input type="file" id="reg-file" class="auth-input" accept="image/*">
                    <button class="btn-primary" onclick="attemptRegister()">Cadastrar</button>
                    <button class="btn-secondary" style="width:100%" onclick="router('login')">Voltar</button>
                </div>
            `;
        }

        async function attemptRegister() {
            const name = $('#reg-name').value;
            const username = $('#reg-user').value.toLowerCase().replace(/\s/g, '');
            const pass = $('#reg-pass').value;
            const fileInput = $('#reg-file');

            if(!name || !username || !pass) return alert('Preencha tudo.');

            // Checar unicidade
            let exists = false;
            await db.ref('users').orderByChild('username').equalTo(username).once('value', s => {
                if(s.exists()) exists = true;
            });

            if(exists) return alert('Este usuário já existe!');

            let avatarUrl = 'https://via.placeholder.com/150';
            if(fileInput.files[0]) {
                avatarUrl = await toBase64(fileInput.files[0]);
            }

            const uid = generateId();
            const newUser = {
                uid, name, username, password: pass, avatar: avatarUrl, role: 'user', bio: ''
            };

            // Owner Check Hardcoded
            if (pass === 'Brookasil1234') newUser.role = 'owner';

            await db.ref(`users/${uid}`).set(newUser);
            loginUser(newUser);
        }

        async function attemptLogin() {
            const username = $('#login-user').value.toLowerCase();
            const pass = $('#login-pass').value;

            db.ref('users').orderByChild('username').equalTo(username).once('value', snap => {
                if(!snap.exists()) return alert('Usuário não encontrado.');
                const userData = Object.values(snap.val())[0];
                if(userData.password !== pass) return alert('Senha incorreta.');
                loginUser(userData);
            });
        }

        function loginUser(user) {
            state.currentUser = user;
            sessionStorage.setItem('g1_user', JSON.stringify(user));
            router('home');
        }

        function logout() {
            state.currentUser = null;
            sessionStorage.removeItem('g1_user');
            router('home');
        }

        function loadSession() {
            const saved = sessionStorage.getItem('g1_user');
            if(saved) state.currentUser = JSON.parse(saved);
            updateHeaderState();
        }

        // --- EDITOR DE NOTÍCIAS (CMS) ---

        function renderEditor() {
            if(!state.currentUser || state.currentUser.role === 'user') return router('home');

            $('#app-container').innerHTML = `
                <div class="auth-container" style="max-width:800px; text-align:left;">
                    <h2 style="margin-bottom:20px;">Painel de Notícias</h2>
                    <div class="editor-container">
                        <label>Título</label>
                        <input type="text" id="news-title">
                        <label>Subtítulo</label>
                        <input type="text" id="news-subtitle">
                        <label>Categoria (Tema)</label>
                        <select id="news-theme">
                            <option>Política</option><option>Polícia</option><option>Educação</option>
                            <option>Esporte</option><option>Entretenimento</option><option>Curiosidades</option>
                        </select>
                        <label>Imagem (Arquivo)</label>
                        <input type="file" id="news-img" accept="image/*">
                        <label>Conteúdo (Use Enter para parágrafos)</label>
                        <textarea id="news-content" style="height:300px"></textarea>
                        
                        <button class="btn-primary" onclick="publishNews()">PUBLICAR NOTÍCIA</button>
                    </div>
                </div>
            `;
        }

        async function publishNews() {
            const title = $('#news-title').value;
            const sub = $('#news-subtitle').value;
            const theme = $('#news-theme').value;
            const content = $('#news-content').value;
            const file = $('#news-img').files[0];

            if(!title || !content) return alert('Título e conteúdo obrigatórios');

            let imgUrl = 'https://via.placeholder.com/800x450';
            if(file) imgUrl = await toBase64(file);

            const newsId = generateId();
            const newPost = {
                id: newsId,
                title, subtitle: sub, theme, content, image: imgUrl,
                authorId: state.currentUser.uid,
                authorName: state.currentUser.name,
                date: new Date().toISOString(),
                isHighlight: false
            };

            await db.ref(`news/${newsId}`).set(newPost);
            alert('Notícia publicada!');
            router('home');
        }

        // --- PERFIL ---
        function handleProfileClick() {
            if(state.currentUser) router('profile');
            else router('login');
        }

        function renderProfile() {
            const u = state.currentUser;
            $('#app-container').innerHTML = `
                <div class="auth-container" style="max-width:600px;">
                    <img src="${u.avatar}" style="width:100px; height:100px; border-radius:50%; object-fit:cover;">
                    <h2>${u.name} ${getRoleBadge(u.role)}</h2>
                    <p style="color:#666">@${u.username}</p>
                    <p style="margin:10px 0;">${u.bio || 'Sem biografia.'}</p>
                    
                    <div style="text-align:left; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                        <h3>Editar Perfil</h3>
                        <label>Nova Biografia</label>
                        <input type="text" id="edit-bio" class="auth-input" value="${u.bio || ''}">
                        <label>Nova Foto</label>
                        <input type="file" id="edit-img" class="auth-input">
                        <button class="btn-primary" onclick="saveProfile()">Salvar Alterações</button>
                    </div>

                    ${u.role === 'owner' ? renderAdminPanel() : ''}
                </div>
            `;
        }

        function renderAdminPanel() {
            return `
                <div style="margin-top:30px; border:2px solid red; padding:10px;">
                    <h3 style="color:red">Área do Dono</h3>
                    <p>Promover Usuário a Jornalista (@usuario)</p>
                    <div style="display:flex; gap:5px;">
                        <input id="promote-user" type="text" class="auth-input" style="margin:0;">
                        <button onclick="promoteUser()" class="btn-primary" style="width:auto;">OK</button>
                    </div>
                </div>
            `;
        }

        async function saveProfile() {
            const bio = $('#edit-bio').value;
            const file = $('#edit-img').files[0];
            let avatar = state.currentUser.avatar;

            if(file) avatar = await toBase64(file);

            const updates = { bio, avatar };
            await db.ref(`users/${state.currentUser.uid}`).update(updates);
            
            // Atualizar sessão local
            state.currentUser.bio = bio;
            state.currentUser.avatar = avatar;
            sessionStorage.setItem('g1_user', JSON.stringify(state.currentUser));
            
            alert('Perfil atualizado!');
            renderProfile();
        }

        async function promoteUser() {
            const targetUser = $('#promote-user').value.replace('@','').trim();
            // Buscar ID pelo username (ineficiente em scale real, ok aqui)
            let targetId = null;
            let currentRole = null;
            
            // Necessário iterar pois users é indexado por UID, não username
            for(let uid in state.users) {
                if(state.users[uid].username === targetUser) {
                    targetId = uid;
                    currentRole = state.users[uid].role;
                    break;
                }
            }

            if(targetId) {
                await db.ref(`users/${targetId}`).update({ role: 'journalist' });
                alert(`@${targetUser} agora é jornalista.`);
            } else {
                alert('Usuário não encontrado.');
            }
        }

        // --- DIVULGAÇÃO DE TRABALHO ---
        function renderDivulgacao() {
            $('#app-container').innerHTML = `
                <div class="auth-container" style="max-width:600px; text-align:left;">
                    <h2 style="color:var(--g1-red);">Divulgação de Trabalho</h2>
                    <p style="margin-bottom:20px; font-size:0.9rem;">Envie sua oportunidade ou serviço. <strong>Toda divulgação passa por análise do Dono.</strong></p>
                    
                    ${state.currentUser ? `
                        <label>Título do Serviço/Vaga</label>
                        <input type="text" id="job-title" class="auth-input">
                        <label>Descrição e Contato</label>
                        <textarea id="job-desc" class="auth-input" style="height:100px;"></textarea>
                        <button class="btn-primary" onclick="sendJobRequest()">Enviar para Análise</button>
                    ` : `<p>Faça login para divulgar.</p>`}
                </div>
            `;
        }

        function sendJobRequest() {
            const title = $('#job-title').value;
            const desc = $('#job-desc').value;
            if(!title || !desc) return alert('Preencha tudo.');

            db.ref('divulgacoes').push({
                title, desc, 
                user: state.currentUser.username,
                status: 'pending',
                date: new Date().toISOString()
            });
            alert('Enviado para análise!');
            router('home');
        }

        // --- PESQUISA ---
        function handleSearch(e) {
            if(e.key === 'Enter') {
                const term = e.target.value.toLowerCase();
                router('search', term);
            }
        }

        function renderSearch(term) {
            const container = $('#app-container');
            const results = state.news.filter(n => 
                n.title.toLowerCase().includes(term) || 
                n.content.toLowerCase().includes(term) ||
                n.theme.toLowerCase().includes(term)
            );

            let html = `<h2 style="margin:20px 0;">Resultados para "${term}"</h2>`;
            if(results.length === 0) html += `<p>Nenhum resultado encontrado.</p>`;
            else {
                html += `<div class="feed-grid">`;
                results.forEach(post => {
                    html += `
                        <div class="card" onclick="router('article', '${post.id}')">
                            <div class="card-img-wrapper"><img src="${post.image}" class="card-img"></div>
                            <div>
                                <div class="card-theme">${post.theme}</div>
                                <h2 class="card-title">${highlightTerm(post.title, term)}</h2>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        // --- HELPERS ---
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function getTimeAgo(dateString) {
            const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " anos atrás";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " meses atrás";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " dias atrás";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " horas atrás";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutos atrás";
            return "Agora mesmo";
        }

        function formatArticleBody(text) {
            // Converte quebras de linha em parágrafos
            return text.split('\n').map(p => p.trim() ? `<p>${p}</p>` : '').join('');
        }

        function highlightTerm(text, term) {
            const regex = new RegExp(`(${term})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        
        function getRoleBadge(role) {
            if(role === 'owner') return '<span class="badge badge-owner">DONO</span>';
            if(role === 'journalist') return '<span class="badge badge-journ">JORNALISTA</span>';
            return '';
        }

        function shareLink() {
            alert('Link copiado para a área de transferência!');
        }

    </script>
</body>
</html>
